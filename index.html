<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¼å¸è¨“ç·´ | åˆ†ç´šæŒ‘æˆ°ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-strong: rgba(255, 255, 255, 0.25);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* é é¢åˆ‡æ›ç³»çµ± */
        .page {
            display: none;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é€šç”¨å®¹å™¨ */
        .container {
            max-width: 600px;
            width: 100%;
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin: auto 0;
        }
        
        header { text-align: center; margin-bottom: 25px; }
        .logo-icon { font-size: 3rem; display: block; margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        h1 { font-size: 2rem; margin-bottom: 5px; }
        .tagline { color: rgba(255,255,255,0.7); font-size: 0.9rem; }

        /* --- é¸æ“‡å™¨æ¨£å¼ --- */
        
        /* 1. é¡åˆ¥é¸æ“‡ (Grid) */
        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .cat-card {
            background: rgba(255,255,255,0.08);
            border: 2px solid transparent;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .cat-card.active {
            background: rgba(255,255,255,0.2);
            border-color: var(--secondary);
            transform: scale(1.02);
        }
        
        .cat-icon { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .cat-name { font-weight: bold; font-size: 1rem; }

        /* 2. é›£åº¦é¸æ“‡ (Row) */
        .difficulty-container {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none; /* JS æ§åˆ¶é¡¯ç¤º */
        }
        .difficulty-container.show { display: block; animation: fadeIn 0.3s; }
        
        .section-title { font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px; display: block; }

        .diff-options {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .diff-btn {
            flex: 1;
            padding: 10px 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .diff-btn:hover { background: rgba(255,255,255,0.1); }
        .diff-btn.active {
            background: var(--secondary);
            border-color: var(--secondary);
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }

        /* 3. è‡ªè¨‚é¢æ¿ */
        .custom-controls {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .custom-controls.show { display: block; animation: fadeIn 0.3s; }
        
        .slider-group { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 5px; }
        input[type="range"] { width: 100%; height: 6px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: white; border-radius: 50%; cursor: pointer; }

        /* é è¦½è³‡è¨Šå€ */
        .preview-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        .preview-text { font-size: 1.1rem; color: var(--secondary); font-weight: bold; }
        .preview-sub { font-size: 0.85rem; opacity: 0.7; margin-top: 4px; }

        /* å‘¼å¸å‹•ç•« */
        .breathing-circle-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circle-bg { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); }
        .circle-lung {
            width: 150px; height: 150px;
            background: radial-gradient(circle, var(--secondary) 0%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 30px var(--secondary);
            opacity: 0.8;
            transform: scale(1);
            /* é—œéµï¼šä½¿ç”¨ CSS transition è®“è®ŠåŒ–å¹³æ»‘ */
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .phase-text { position: absolute; text-align: center; z-index: 10; }
        .timer-big { font-size: 4rem; font-weight: bold; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .phase-label { font-size: 1.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; }
        
        /* æŒ‰éˆ•èˆ‡åˆ—è¡¨ */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: transform 0.2s; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--secondary); color: #fff; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; }
        
        .record-list { list-style: none; max-height: 400px; overflow-y: auto; width: 100%; }
        .record-item { background: rgba(255,255,255,0.1); margin-bottom: 10px; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .db-status { position: fixed; top: 10px; right: 10px; font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: rgba(0,0,0,0.5); }
        .online { color: var(--secondary); }
    </style>
</head>
<body>

    <div class="db-status" id="db-status">â— é›¢ç·šæ¨¡å¼</div>

    <div id="home-page" class="page active">
        <div class="container">
            <header>
                <div class="logo-icon">ğŸ§˜â€â™‚ï¸</div>
                <h1>å‘¼å¸è¨“ç·´</h1>
                <p class="tagline">é¸æ“‡é©åˆæ‚¨çš„ç¯€å¥èˆ‡å¼·åº¦</p>
            </header>

            <span class="section-title">é¸æ“‡æ¨¡å¼</span>
            <div class="category-grid">
                <div class="cat-card active" onclick="selectCategory('relax')" id="cat-relax">
                    <span class="cat-icon">ğŸŒ™</span>
                    <span class="cat-name">æ”¾é¬†</span>
                </div>
                <div class="cat-card" onclick="selectCategory('balance')" id="cat-balance">
                    <span class="cat-icon">âš–ï¸</span>
                    <span class="cat-name">å¹³è¡¡</span>
                </div>
                <div class="cat-card" onclick="selectCategory('energy')" id="cat-energy">
                    <span class="cat-icon">âš¡</span>
                    <span class="cat-name">æç¥</span>
                </div>
                <div class="cat-card" onclick="selectCategory('custom')" id="cat-custom">
                    <span class="cat-icon">âš™ï¸</span>
                    <span class="cat-name">è‡ªè¨‚</span>
                </div>
            </div>

            <div id="difficulty-panel" class="difficulty-container show">
                <span class="section-title">é¸æ“‡å¼·åº¦</span>
                <div class="diff-options">
                    <button class="diff-btn active" onclick="selectDifficulty('easy')" id="diff-easy">å®¹æ˜“</button>
                    <button class="diff-btn" onclick="selectDifficulty('medium')" id="diff-medium">é€²éš</button>
                    <button class="diff-btn" onclick="selectDifficulty('hard')" id="diff-hard">é«˜ç´š</button>
                </div>
            </div>

            <div id="custom-panel" class="custom-controls">
                <span class="section-title">è‡ªè¨‚ç§’æ•¸</span>
                <div class="slider-group">
                    <div class="slider-label"><span>å¸æ°£</span><span id="label-inhale">4 ç§’</span></div>
                    <input type="range" id="input-inhale" min="2" max="15" value="4" oninput="updateCustomSettings()">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>å‘¼æ°£</span><span id="label-exhale">6 ç§’</span></div>
                    <input type="range" id="input-exhale" min="2" max="20" value="6" oninput="updateCustomSettings()">
                </div>
            </div>

            <div class="preview-info">
                <div class="preview-text" id="preview-text">å¸ 4 ç§’ â®• å‘¼ 6 ç§’</div>
                <div class="preview-sub" id="preview-desc">é©åˆåˆå­¸è€…ï¼Œå¹«åŠ©å‰¯äº¤æ„Ÿç¥ç¶“æ”¾é¬†</div>
            </div>

            <button class="btn btn-primary" onclick="startGame()">
                <span>é–‹å§‹ç·´ç¿’</span>
            </button>
            
            <button class="btn btn-outline" onclick="showPage('history-page')">
                <span>æŸ¥çœ‹æ­·å²è¨˜éŒ„</span>
            </button>
        </div>
    </div>

    <div id="game-page" class="page">
        <div class="container" style="text-align: center;">
            <div class="breathing-circle-container">
                <div class="circle-bg"></div>
                <div class="circle-lung" id="lung-visual"></div>
                <div class="phase-text">
                    <div class="phase-label" id="phase-label">æº–å‚™</div>
                    <div class="timer-big" id="main-timer">0</div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-around; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-top: 20px;">
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold;" id="stat-cycles">0</div>
                    <div style="font-size: 0.8rem; opacity: 0.7;">å¾ªç’°</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold;" id="stat-time">00:00</div>
                    <div style="font-size: 0.8rem; opacity: 0.7;">æ™‚é–“</div>
                </div>
            </div>

            <p id="instruction-text" style="margin: 20px 0; height: 1.5em; color: rgba(255,255,255,0.8);">
                è·Ÿéš¨å¼•å°å‘¼å¸...
            </p>

            <button class="btn btn-danger" onclick="stopGame()">çµæŸç·´ç¿’</button>
        </div>
    </div>

    <div id="history-page" class="page">
        <div class="container">
            <header>
                <h2>ç·´ç¿’è¨˜éŒ„</h2>
            </header>
            <ul class="record-list" id="record-list">
                <li style="text-align:center; padding:20px;">è¼‰å…¥ä¸­...</li>
            </ul>
            <button class="btn btn-outline" onclick="showPage('home-page')">è¿”å›é¦–é </button>
        </div>
    </div>

    <script>
        // ==================== è¨­å®šèˆ‡è³‡æ–™çµæ§‹ ====================
        // å®šç¾©æ‰€æœ‰æ¨¡å¼èˆ‡é›£åº¦çš„ç§’æ•¸é…ç½®
        const PRESETS = {
            relax: {
                easy:   { i: 4, e: 6, desc: "é©åˆåˆå­¸è€…ï¼ŒåŸºç¤æ”¾é¬†" },
                medium: { i: 4, e: 8, desc: "é€²éšæ”¾é¬†ï¼Œå»¶é•·å‘¼æ°£é‡‹æ”¾å£“åŠ›" },
                hard:   { i: 5, e: 10, desc: "æ·±åº¦æ”¾é¬†ï¼Œéœ€è¦è¼ƒå¥½çš„è‚ºæ´»é‡" }
            },
            balance: {
                easy:   { i: 4, e: 4, desc: "ç°¡å–®çš„ç­‰é•·å‘¼å¸ï¼Œç©©å®šæƒ…ç·’" },
                medium: { i: 5, e: 5, desc: "æ¨™æº–å…±æŒ¯å‘¼å¸é »ç‡" },
                hard:   { i: 6, e: 6, desc: "æ¯åˆ†é˜5æ¬¡å‘¼å¸ï¼Œé»ƒé‡‘å¹³è¡¡ç‹€æ…‹" }
            },
            energy: {
                easy:   { i: 4, e: 2, desc: "æº«å’Œæç¥ï¼Œå¢åŠ æ°§æ°£æ”å…¥" },
                medium: { i: 5, e: 2, desc: "å¿«é€Ÿå–šé†’å¤§è…¦" },
                hard:   { i: 6, e: 1, desc: "å¼·åŠ›å‘¼å¸ï¼Œè¿…é€Ÿæå‡å°ˆæ³¨åŠ›" }
            },
            custom: {
                // è‡ªè¨‚æ¨¡å¼çš„æ•¸å€¼ç”±æ»‘æ¡¿æ±ºå®šï¼Œé€™è£¡æ˜¯åˆå§‹å€¼
                i: 4, e: 6, desc: "è‡ªè¨‚æ‚¨çš„å°ˆå±¬ç¯€å¥"
            }
        };

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        const state = {
            category: 'relax', // relax, balance, energy, custom
            difficulty: 'easy', // easy, medium, hard
            customSettings: { i: 4, e: 6 },
            
            // ç·´ç¿’ä¸­çš„ç‹€æ…‹
            session: {
                active: false,
                phase: 'inhale',
                startTime: null,
                totalSeconds: 0,
                cycles: 0,
                timerRef: null,
                currentConfig: null // å¯¦éš›åŸ·è¡Œçš„ç§’æ•¸è¨­å®š {i, e}
            }
        };

        // ==================== Supabase (ä¿ç•™åŸè¨­å®š) ====================
        const SUPABASE_URL = 'https://fayorxvfxtrycjiiiyfu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheW9yeHZmeHRyeWNqaWlpeWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzY1MTAsImV4cCI6MjA3OTg1MjUxMH0.7znE_AaNg6zESUO-RoSsyFqxCgcxjPT_pQiN557e6Nw';
        let supabase;
        let isOnline = false;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            isOnline = true;
            document.getElementById('db-status').innerHTML = 'â— é›²ç«¯é€£ç·š';
            document.getElementById('db-status').classList.add('online');
        } catch (e) { console.error("Supabase init error", e); }

        // ==================== é é¢å°èˆª ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(pageId === 'history-page') loadRecords();
        }

        // ==================== ä»‹é¢äº’å‹•é‚è¼¯ ====================
        
        // 1. é¸æ“‡é¡åˆ¥ (Relax, Balance...)
        function selectCategory(cat) {
            state.category = cat;
            
            // æ›´æ–°å¡ç‰‡æ¨£å¼
            document.querySelectorAll('.cat-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`cat-${cat}`).classList.add('active');

            // é¡¯ç¤º/éš±è—æ§åˆ¶é¢æ¿
            const diffPanel = document.getElementById('difficulty-panel');
            const customPanel = document.getElementById('custom-panel');

            if (cat === 'custom') {
                diffPanel.classList.remove('show');
                customPanel.classList.add('show');
            } else {
                diffPanel.classList.add('show');
                customPanel.classList.remove('show');
            }
            
            updatePreview();
        }

        // 2. é¸æ“‡é›£åº¦ (Easy, Medium...)
        function selectDifficulty(diff) {
            state.difficulty = diff;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`diff-${diff}`).classList.add('active');
            
            updatePreview();
        }

        // 3. æ›´æ–°è‡ªè¨‚æ•¸å€¼
        function updateCustomSettings() {
            const i = parseInt(document.getElementById('input-inhale').value);
            const e = parseInt(document.getElementById('input-exhale').value);
            
            document.getElementById('label-inhale').textContent = `${i} ç§’`;
            document.getElementById('label-exhale').textContent = `${e} ç§’`;
            
            state.customSettings = { i, e };
            updatePreview();
        }

        // 4. æ›´æ–°ä¸‹æ–¹é è¦½æ–‡å­—
        function updatePreview() {
            let config;
            let desc = "";

            if (state.category === 'custom') {
                config = state.customSettings;
                desc = PRESETS.custom.desc;
            } else {
                config = PRESETS[state.category][state.difficulty];
                desc = config.desc;
            }

            document.getElementById('preview-text').innerHTML = 
                `å¸ <span style="color:#2ecc71">${config.i}</span> ç§’ â®• å‘¼ <span style="color:#3498db">${config.e}</span> ç§’`;
            document.getElementById('preview-desc').textContent = desc;
        }

        // ==================== éŠæˆ²æ ¸å¿ƒé‚è¼¯ ====================
        function startGame() {
            // ç¢ºå®šç•¶å‰ä½¿ç”¨çš„é…ç½®
            if (state.category === 'custom') {
                state.session.currentConfig = { ...state.customSettings };
            } else {
                state.session.currentConfig = { ...PRESETS[state.category][state.difficulty] };
            }

            // åˆå§‹åŒ–ç‹€æ…‹
            state.session.active = true;
            state.session.phase = 'inhale';
            state.session.startTime = Date.now();
            state.session.totalSeconds = 0;
            state.session.cycles = 0;
            
            // é‡ç½® UI
            document.getElementById('stat-cycles').textContent = '0';
            document.getElementById('stat-time').textContent = '00:00';
            
            // è¨­å®š CSS Transition æ™‚é–“ (åˆæ¬¡è¨­å®šç‚ºå¸æ°£æ™‚é–“)
            const lung = document.getElementById('lung-visual');
            lung.style.transitionDuration = `${state.session.currentConfig.i}s`;

            showPage('game-page');
            runGameLoop();
        }

        function runGameLoop() {
            const timerDisplay = document.getElementById('main-timer');
            let phaseTimeElapsed = 0; // ç•¶å‰éšæ®µéäº†å¹¾ç§’

            // å•Ÿå‹•è¦–è¦ºèˆ‡å€’æ•¸
            updatePhaseVisuals();

            state.session.timerRef = setInterval(() => {
                if (!state.session.active) return;

                const config = state.session.currentConfig;
                const targetTime = state.session.phase === 'inhale' ? config.i : config.e;

                state.session.totalSeconds++;
                phaseTimeElapsed++;

                // ç¸½æ™‚é–“é¡¯ç¤º
                const mins = Math.floor(state.session.totalSeconds / 60).toString().padStart(2, '0');
                const secs = (state.session.totalSeconds % 60).toString().padStart(2, '0');
                document.getElementById('stat-time').textContent = `${mins}:${secs}`;

                // å€’æ•¸è¨ˆæ™‚é¡¯ç¤º
                const remaining = targetTime - phaseTimeElapsed;
                timerDisplay.textContent = Math.max(remaining, 0) + 1; // +1 è®“è¦–è¦ºä¸æœƒåœåœ¨ 0 å¤ªä¹…

                // éšæ®µåˆ‡æ›
                if (phaseTimeElapsed >= targetTime) {
                    phaseTimeElapsed = 0;
                    switchPhase();
                }

            }, 1000);
        }

        function switchPhase() {
            if (state.session.phase === 'inhale') {
                state.session.phase = 'exhale';
            } else {
                state.session.phase = 'inhale';
                state.session.cycles++;
                document.getElementById('stat-cycles').textContent = state.session.cycles;
            }
            updatePhaseVisuals();
        }

        function updatePhaseVisuals() {
            const { phase, currentConfig } = state.session;
            const lung = document.getElementById('lung-visual');
            const phaseLabel = document.getElementById('phase-label');
            const instruction = document.getElementById('instruction-text');
            const timerDisplay = document.getElementById('main-timer');

            // é‡ç½®å€’æ•¸æ•¸å­—
            timerDisplay.textContent = phase === 'inhale' ? currentConfig.i : currentConfig.e;

            // è¨­ç½® CSS Transition æ™‚é–“
            const duration = phase === 'inhale' ? currentConfig.i : currentConfig.e;
            lung.style.transitionDuration = `${duration}s`;

            if (phase === 'inhale') {
                phaseLabel.textContent = "å¸æ°£";
                phaseLabel.style.color = "#2ecc71";
                instruction.textContent = "ç”¨é¼»å­ç·©æ…¢å¸æ°£ï¼Œæ„Ÿå—èƒ¸è…”æ“´å¼µ...";
                lung.style.transform = "scale(1.8)";
                lung.style.backgroundColor = "rgba(46, 204, 113, 0.6)";
            } else {
                phaseLabel.textContent = "å‘¼æ°£";
                phaseLabel.style.color = "#3498db";
                instruction.textContent = "ç”¨å˜´å·´æ…¢æ…¢åæ°£ï¼Œæ”¾é¬†å…¨èº«...";
                lung.style.transform = "scale(1)";
                lung.style.backgroundColor = "rgba(52, 152, 219, 0.6)";
            }
        }

        function stopGame() {
            state.session.active = false;
            clearInterval(state.session.timerRef);
            
            if (state.session.totalSeconds > 5) {
                saveRecord();
            }
            showPage('home-page');
        }

        // ==================== æ•¸æ“šå„²å­˜èˆ‡è®€å– ====================
        async function saveRecord() {
            const config = state.session.currentConfig;
            
            // çµ„åˆæ¨¡å¼åç¨±ï¼Œä¾‹å¦‚ "relax-medium" æˆ– "custom"
            let modeName = state.category;
            if (state.category !== 'custom') {
                modeName += `-${state.difficulty}`;
            }

            const record = {
                mode: modeName,
                inhale: config.i,
                exhale: config.e,
                cycles: state.session.cycles,
                duration: state.session.totalSeconds,
                created_at: new Date().toISOString()
            };

            // 1. LocalStorage
            const localRecords = JSON.parse(localStorage.getItem('breath_records_v2') || '[]');
            localRecords.unshift(record);
            localStorage.setItem('breath_records_v2', JSON.stringify(localRecords));

            // 2. Supabase
            if (isOnline) {
                const { error } = await supabase
                    .from('breathing_records')
                    .insert([{
                        difficulty: record.mode,
                        cycles: record.cycles,
                        total_time: record.duration,
                        inhale_duration: record.inhale,
                        exhale_duration: record.exhale,
                        created_at: record.created_at
                    }]);
                if (error) console.error("Supabase Save Error:", error);
            }
        }

        async function loadRecords() {
            const list = document.getElementById('record-list');
            list.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';
            
            let records = [];

            if (isOnline) {
                const { data, error } = await supabase
                    .from('breathing_records')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (!error && data) {
                    records = data.map(d => ({
                        mode: d.difficulty,
                        cycles: d.cycles,
                        duration: d.total_time,
                        created_at: d.created_at,
                        i: d.inhale_duration,
                        e: d.exhale_duration
                    }));
                }
            }

            if (records.length === 0) {
                records = JSON.parse(localStorage.getItem('breath_records_v2') || '[]');
            }

            list.innerHTML = '';
            if (records.length === 0) {
                list.innerHTML = '<li class="record-item" style="justify-content:center;">å°šç„¡è¨˜éŒ„</li>';
                return;
            }

            // ä¸­æ–‡å°ç…§è¡¨
            const dict = {
                'relax': 'æ”¾é¬†', 'balance': 'å¹³è¡¡', 'energy': 'æç¥', 'custom': 'è‡ªè¨‚',
                'easy': 'å®¹æ˜“', 'medium': 'é€²éš', 'hard': 'é«˜ç´š'
            };

            records.forEach(r => {
                const li = document.createElement('li');
                li.className = 'record-item';
                
                const date = new Date(r.created_at).toLocaleString('zh-TW', {
                    month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                // æ ¼å¼åŒ–åç¨±: relax-medium -> æ”¾é¬† (é€²éš)
                let displayMode = r.mode;
                if (r.mode.includes('-')) {
                    const [cat, diff] = r.mode.split('-');
                    displayMode = `${dict[cat] || cat} <small>(${dict[diff] || diff})</small>`;
                } else {
                    displayMode = dict[r.mode] || r.mode;
                }
                
                // å¦‚æœæœ‰è©³ç´°ç§’æ•¸è³‡æ–™å°±é¡¯ç¤ºï¼Œæ²’æœ‰å‰‡ä¸é¡¯ç¤º
                const details = (r.i && r.e) ? `<br><small style="opacity:0.6">å¸${r.i} å‘¼${r.e}</small>` : '';

                li.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:var(--secondary)">${displayMode}</div>
                        <div style="font-size:0.8rem; opacity:0.7">${date}${details}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:1.1rem">${r.cycles} å¾ªç’°</div>
                        <div style="font-size:0.8rem; opacity:0.7">${Math.floor(r.duration/60)}åˆ†${r.duration%60}ç§’</div>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // åˆå§‹åŒ–
        updatePreview();
    </script>
</body>
</html>
