<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¼å¸è¨“ç·´ | å°ˆæ³¨èˆ‡æ”¾é¬†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-strong: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* é é¢åˆ‡æ›ç³»çµ± */
        .page {
            display: none;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é€šç”¨å®¹å™¨ */
        .container {
            max-width: 600px;
            width: 100%;
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin: auto 0;
        }
        
        /* æ¨™é¡Œèˆ‡ LOGO */
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo-icon {
            font-size: 3rem;
            display: block;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        h1 { font-size: 2rem; margin-bottom: 5px; }
        .tagline { color: rgba(255,255,255,0.8); font-size: 0.9rem; }

        /* é›£åº¦é¸æ“‡å¡ç‰‡ */
        .mode-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .mode-card {
            background: var(--glass);
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-card:hover { background: var(--glass-strong); }
        
        .mode-card.active {
            border-color: var(--secondary);
            background: rgba(46, 204, 113, 0.2);
            transform: scale(1.02);
        }

        .mode-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .mode-desc { font-size: 0.85rem; opacity: 0.8; }

        /* è‡ªè¨‚æ¨¡å¼å€åŸŸ */
        .custom-controls {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: none; /* é è¨­éš±è— */
        }
        
        .custom-controls.show { display: block; animation: fadeIn 0.3s; }

        .slider-group { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 5px; }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        /* å‘¼å¸å‹•ç•« */
        .breathing-circle-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .circle-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .circle-lung {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, var(--secondary) 0%, transparent 70%);
            border-radius: 50%;
            transition: transform 0.1s linear; /* ç”¨ JS æ§åˆ¶ */
            box-shadow: 0 0 30px var(--secondary);
            opacity: 0.8;
        }

        .phase-text {
            position: absolute;
            text-align: center;
            z-index: 10;
        }

        .timer-big { font-size: 4rem; font-weight: bold; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .phase-label { font-size: 1.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; }
        
        /* çµ±è¨ˆæ•¸æ“š */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            width: 100%;
        }
        .stat-item { text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; }
        .stat-lbl { font-size: 0.8rem; opacity: 0.7; }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--secondary); color: #fff; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; }

        /* åˆ—è¡¨æ¨£å¼ */
        .record-list {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
        }
        .record-item {
            background: rgba(255,255,255,0.1);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .record-date { font-size: 0.8rem; opacity: 0.7; }
        
        /* é€£ç·šç‹€æ…‹ */
        .db-status {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(0,0,0,0.5);
        }
        .online { color: var(--secondary); }
        .offline { color: var(--danger); }
    </style>
</head>
<body>

    <div class="db-status" id="db-status">â— é›¢ç·šæ¨¡å¼</div>

    <div id="home-page" class="page active">
        <div class="container">
            <header>
                <div class="logo-icon">ğŸŒ¬ï¸</div>
                <h1>å‘¼å¸è¨“ç·´</h1>
                <p class="tagline">è‡ªè¨‚ç¯€å¥ï¼Œå°ˆæ³¨ç•¶ä¸‹</p>
            </header>

            <h3 style="margin-bottom: 15px;">é¸æ“‡æ¨¡å¼</h3>
            <div class="mode-grid">
                <div class="mode-card active" onclick="selectMode('relax')">
                    <div class="mode-title">æ”¾é¬†</div>
                    <div class="mode-desc">å¸ 4 ç§’ / å‘¼ 6 ç§’</div>
                </div>
                <div class="mode-card" onclick="selectMode('balance')">
                    <div class="mode-title">å¹³è¡¡</div>
                    <div class="mode-desc">å¸ 5 ç§’ / å‘¼ 5 ç§’</div>
                </div>
                <div class="mode-card" onclick="selectMode('energy')">
                    <div class="mode-title">æç¥</div>
                    <div class="mode-desc">å¸ 4 ç§’ / å‘¼ 2 ç§’</div>
                </div>
                <div class="mode-card" onclick="selectMode('custom')">
                    <div class="mode-title">è‡ªè¨‚</div>
                    <div class="mode-desc">è‡ªé¸ç§’æ•¸</div>
                </div>
            </div>

            <div id="custom-panel" class="custom-controls">
                <div class="slider-group">
                    <div class="slider-label">
                        <span>å¸æ°£æ™‚é–“</span>
                        <span id="label-inhale">4 ç§’</span>
                    </div>
                    <input type="range" id="input-inhale" min="2" max="15" value="4" oninput="updateCustomLabels()">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>å‘¼æ°£æ™‚é–“</span>
                        <span id="label-exhale">6 ç§’</span>
                    </div>
                    <input type="range" id="input-exhale" min="2" max="20" value="6" oninput="updateCustomLabels()">
                </div>
            </div>

            <button class="btn btn-primary" onclick="startGame()">
                <span>é–‹å§‹ç·´ç¿’</span>
            </button>
            
            <button class="btn btn-outline" onclick="showPage('history-page')">
                <span>æŸ¥çœ‹æ­·å²è¨˜éŒ„</span>
            </button>
        </div>
    </div>

    <div id="game-page" class="page">
        <div class="container" style="text-align: center;">
            <div class="breathing-circle-container">
                <div class="circle-bg"></div>
                <div class="circle-lung" id="lung-visual"></div>
                <div class="phase-text">
                    <div class="phase-label" id="phase-label">æº–å‚™</div>
                    <div class="timer-big" id="main-timer">0</div>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-val" id="stat-cycles">0</div>
                    <div class="stat-lbl">å¾ªç’°æ¬¡æ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="stat-time">00:00</div>
                    <div class="stat-lbl">ç¸½æ™‚é–“</div>
                </div>
            </div>

            <p id="instruction-text" style="margin: 20px 0; height: 1.5em; color: rgba(255,255,255,0.8);">
                è·Ÿéš¨å¼•å°å‘¼å¸...
            </p>

            <button class="btn btn-danger" onclick="stopGame()">çµæŸç·´ç¿’</button>
        </div>
    </div>

    <div id="history-page" class="page">
        <div class="container">
            <header>
                <h2>ç·´ç¿’è¨˜éŒ„</h2>
            </header>
            
            <ul class="record-list" id="record-list">
                <li style="text-align:center; padding:20px;">è¼‰å…¥ä¸­...</li>
            </ul>

            <button class="btn btn-outline" onclick="showPage('home-page')">è¿”å›é¦–é </button>
        </div>
    </div>

    <script>
        // ==================== Supabase è¨­å®š ====================
        const SUPABASE_URL = 'https://fayorxvfxtrycjiiiyfu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheW9yeHZmeHRyeWNqaWlpeWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzY1MTAsImV4cCI6MjA3OTg1MjUxMH0.7znE_AaNg6zESUO-RoSsyFqxCgcxjPT_pQiN557e6Nw';

        let supabase;
        let isOnline = false;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            isOnline = true;
            document.getElementById('db-status').innerHTML = 'â— é›²ç«¯é€£ç·š';
            document.getElementById('db-status').classList.add('online');
        } catch (e) {
            console.error("Supabase init error", e);
        }

        // ==================== æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ====================
        const state = {
            currentMode: 'relax', // relax, balance, energy, custom
            settings: {
                relax: { inhale: 4, exhale: 6 },
                balance: { inhale: 5, exhale: 5 },
                energy: { inhale: 4, exhale: 2 },
                custom: { inhale: 4, exhale: 6 }
            },
            session: {
                active: false,
                phase: 'inhale', // inhale, exhale
                startTime: null,
                totalSeconds: 0,
                cycles: 0,
                timerRef: null,
                animationRef: null
            }
        };

        // ==================== é é¢å°èˆª ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if(pageId === 'history-page') {
                loadRecords();
            }
        }

        // ==================== è¨­å®šèˆ‡æ¨¡å¼é¸æ“‡ ====================
        function selectMode(mode) {
            state.currentMode = mode;
            
            // UI æ›´æ–°
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active'); // æ³¨æ„ï¼šåœ¨onclickä¸­ä½¿ç”¨éœ€ç¢ºä¿eventå‚³é
            
            // é¡¯ç¤º/éš±è—è‡ªè¨‚é¢æ¿
            const panel = document.getElementById('custom-panel');
            if (mode === 'custom') {
                panel.classList.add('show');
            } else {
                panel.classList.remove('show');
            }
        }
        
        // ä¿®æ­£ï¼šæ‰‹å‹•ç¶å®š click äº‹ä»¶ä»¥ç¢ºä¿ active class æ­£ç¢ºåˆ‡æ›
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function updateCustomLabels() {
            const inhale = parseInt(document.getElementById('input-inhale').value);
            const exhale = parseInt(document.getElementById('input-exhale').value);
            
            document.getElementById('label-inhale').textContent = `${inhale} ç§’`;
            document.getElementById('label-exhale').textContent = `${exhale} ç§’`;
            
            state.settings.custom.inhale = inhale;
            state.settings.custom.exhale = exhale;
        }

        // ==================== éŠæˆ²é‚è¼¯ (æ ¸å¿ƒä¿®æ”¹) ====================
        function startGame() {
            const config = state.settings[state.currentMode];
            
            // åˆå§‹åŒ–ç‹€æ…‹
            state.session = {
                active: true,
                phase: 'inhale',
                startTime: Date.now(),
                totalSeconds: 0,
                cycles: 0,
                timerRef: null,
                phaseTime: 0,
                config: config
            };

            // é‡ç½® UI
            document.getElementById('stat-cycles').textContent = '0';
            document.getElementById('stat-time').textContent = '00:00';
            showPage('game-page');
            
            runGameLoop();
        }

        function runGameLoop() {
            const { config } = state.session;
            const lung = document.getElementById('lung-visual');
            const phaseLabel = document.getElementById('phase-label');
            const timerDisplay = document.getElementById('main-timer');
            const instruction = document.getElementById('instruction-text');
            
            let phaseElapsed = 0; // ç•¶å‰éšæ®µç¶“éçš„ç§’æ•¸
            
            // æ¯ä¸€ç§’æ›´æ–°ä¸€æ¬¡é‚è¼¯
            state.session.timerRef = setInterval(() => {
                if (!state.session.active) return;

                state.session.totalSeconds++;
                phaseElapsed++;

                // æ›´æ–°ç¸½æ™‚é–“é¡¯ç¤º
                const mins = Math.floor(state.session.totalSeconds / 60).toString().padStart(2, '0');
                const secs = (state.session.totalSeconds % 60).toString().padStart(2, '0');
                document.getElementById('stat-time').textContent = `${mins}:${secs}`;

                // ç²å–ç•¶å‰éšæ®µçš„ç›®æ¨™æ™‚é–“
                const targetTime = state.session.phase === 'inhale' ? config.inhale : config.exhale;
                const remaining = targetTime - phaseElapsed;

                // æ›´æ–°å€’æ•¸è¨ˆæ™‚
                timerDisplay.textContent = Math.max(remaining, 0) + 1; // +1 è®“è¦–è¦ºä¸Šæ›´è‡ªç„¶

                // éšæ®µåˆ‡æ›é‚è¼¯
                if (phaseElapsed >= targetTime) {
                    phaseElapsed = 0;
                    switchPhase();
                }

            }, 1000);

            // å•Ÿå‹•ç¬¬ä¸€å€‹éšæ®µ
            updatePhaseVisuals();
            
            // å‹•ç•«å¾ªç’° (æ›´å¹³æ»‘çš„è¦–è¦ºæ•ˆæœ)
            function animate() {
                if (!state.session.active) return;
                
                const currentDuration = state.session.phase === 'inhale' ? config.inhale : config.exhale;
                // è¨ˆç®—é€²åº¦ 0.0 ~ 1.0
                // ç”±æ–¼ setInterval å’Œ requestAnimationFrame ä¸åŒæ­¥ï¼Œé€™è£¡åšç°¡å–®çš„è¦–è¦ºæ¨¡æ“¬
                // ç‚ºäº†ç²¾ç¢ºï¼Œæˆ‘å€‘ä½¿ç”¨ CSS transitionï¼ŒJS åªè² è²¬è§¸ç™¼ç‹€æ…‹
                
                requestAnimationFrame(animate);
            }
            animate();
        }

        function switchPhase() {
            if (state.session.phase === 'inhale') {
                state.session.phase = 'exhale';
            } else {
                state.session.phase = 'inhale';
                state.session.cycles++;
                document.getElementById('stat-cycles').textContent = state.session.cycles;
            }
            updatePhaseVisuals();
        }

        function updatePhaseVisuals() {
            const { phase, config } = state.session;
            const lung = document.getElementById('lung-visual');
            const phaseLabel = document.getElementById('phase-label');
            const instruction = document.getElementById('instruction-text');
            const timerDisplay = document.getElementById('main-timer');

            // é‡ç½®éšæ®µè¨ˆæ™‚é¡¯ç¤º
            timerDisplay.textContent = phase === 'inhale' ? config.inhale : config.exhale;

            if (phase === 'inhale') {
                phaseLabel.textContent = "å¸æ°£";
                phaseLabel.style.color = "#2ecc71"; // ç¶ è‰²
                instruction.textContent = "ç”¨é¼»å­ç·©æ…¢å¸æ°£ï¼Œæ„Ÿå—èƒ¸è…”æ“´å¼µ...";
                
                // å‹•ç•«ï¼šè®Šå¤§
                lung.style.transition = `transform ${config.inhale}s cubic-bezier(0.4, 0, 0.2, 1)`;
                lung.style.transform = "scale(1.8)";
                lung.style.backgroundColor = "rgba(46, 204, 113, 0.6)";

            } else {
                phaseLabel.textContent = "å‘¼æ°£";
                phaseLabel.style.color = "#3498db"; // è—è‰²
                instruction.textContent = "ç”¨å˜´å·´æ…¢æ…¢åæ°£ï¼Œæ”¾é¬†å…¨èº«...";
                
                // å‹•ç•«ï¼šè®Šå°
                lung.style.transition = `transform ${config.exhale}s cubic-bezier(0.4, 0, 0.2, 1)`;
                lung.style.transform = "scale(1)";
                lung.style.backgroundColor = "rgba(52, 152, 219, 0.6)";
            }
        }

        function stopGame() {
            state.session.active = false;
            clearInterval(state.session.timerRef);
            
            // å„²å­˜è¨˜éŒ„
            if (state.session.totalSeconds > 5) {
                saveRecord();
            }
            
            showPage('home-page');
        }

        // ==================== æ•¸æ“šå„²å­˜ ====================
        async function saveRecord() {
            const record = {
                mode: state.currentMode,
                inhale: state.session.config.inhale,
                exhale: state.session.config.exhale,
                cycles: state.session.cycles,
                duration: state.session.totalSeconds,
                created_at: new Date().toISOString()
            };

            // 1. å­˜å…¥ LocalStorage (å‚™ä»½)
            const localRecords = JSON.parse(localStorage.getItem('breath_records') || '[]');
            localRecords.unshift(record);
            localStorage.setItem('breath_records', JSON.stringify(localRecords));

            // 2. å­˜å…¥ Supabase
            if (isOnline) {
                const { error } = await supabase
                    .from('breathing_records') // å‡è¨­è³‡æ–™è¡¨åç¨±ä¸è®Š
                    .insert([{
                        difficulty: record.mode, // æ˜ å°„èˆŠæ¬„ä½å
                        cycles: record.cycles,
                        total_time: record.duration,
                        inhale_duration: record.inhale,
                        exhale_duration: record.exhale, // ç§»é™¤ hold_duration
                        created_at: record.created_at
                    }]);
                
                if (error) console.error("Supabase Save Error:", error);
            }
        }

        async function loadRecords() {
            const list = document.getElementById('record-list');
            list.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';
            
            let records = [];

            // å„ªå…ˆå˜—è©¦è®€å– Supabase
            if (isOnline) {
                const { data, error } = await supabase
                    .from('breathing_records')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (!error && data) {
                    records = data.map(d => ({
                        mode: d.difficulty,
                        cycles: d.cycles,
                        duration: d.total_time,
                        created_at: d.created_at
                    }));
                }
            }

            // å¦‚æœæ²’æŠ“åˆ°æˆ–é›¢ç·šï¼Œè®€å– LocalStorage
            if (records.length === 0) {
                records = JSON.parse(localStorage.getItem('breath_records') || '[]');
            }

            // æ¸²æŸ“
            list.innerHTML = '';
            if (records.length === 0) {
                list.innerHTML = '<li class="record-item" style="justify-content:center;">å°šç„¡è¨˜éŒ„</li>';
                return;
            }

            records.forEach(r => {
                const li = document.createElement('li');
                li.className = 'record-item';
                
                const date = new Date(r.created_at).toLocaleString('zh-TW', {
                    month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                // ç¿»è­¯æ¨¡å¼åç¨±
                const modeName = {
                    'relax': 'æ”¾é¬†', 'balance': 'å¹³è¡¡', 'energy': 'æç¥', 'custom': 'è‡ªè¨‚',
                    'beginner': 'åˆç´š', 'intermediate': 'é€²éš', 'advanced': 'é«˜ç´š'
                }[r.mode] || r.mode;

                li.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:var(--secondary)">${modeName}</div>
                        <div class="record-date">${date}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:1.1rem">${r.cycles} å¾ªç’°</div>
                        <div style="font-size:0.8rem opacity:0.7">${Math.floor(r.duration/60)}åˆ†${r.duration%60}ç§’</div>
                    </div>
                `;
                list.appendChild(li);
            });
        }
        
        // åˆå§‹åŒ–ï¼šé è¨­é¸æ“‡æ”¾é¬†æ¨¡å¼
        updateCustomLabels();
    </script>
</body>
</html>
