<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¼å¸è¨“ç·´éŠæˆ² | å±æ¯æŒ‘æˆ°</title>
    <!-- æ·»åŠ  Supabase å®¢æˆ¶ç«¯åº« -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #3498db;
            --primary-light: #5dade2;
            --primary-dark: #2980b9;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f5f9fc;
            --dark: #34495e;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        header {
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .tagline {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }
        
        .game-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
            }
        }
        
        .animation-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .controls-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .breathing-animation {
            position: relative;
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }
        
        .lung-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .lung {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M30,20 Q50,5 70,20 Q85,30 85,50 Q85,70 70,80 Q50,95 30,80 Q15,70 15,50 Q15,30 30,20 Z" fill="rgba(255,255,255,0.7)" stroke="rgba(255,255,255,0.9)" stroke-width="2"/></svg>') no-repeat center;
            background-size: contain;
            transition: transform 0.5s ease-in-out;
        }
        
        .breath-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            transition: bottom 1s ease-in-out;
        }
        
        .breath-path {
            position: absolute;
            width: 4px;
            background: rgba(255, 255, 255, 0.5);
            left: 50%;
            transform: translateX(-50%);
            top: 10%;
            bottom: 10%;
            border-radius: 2px;
        }
        
        .instructions {
            margin: 20px 0;
            font-size: 1.2rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .timer {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .phase {
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .difficulty-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .difficulty-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .difficulty-card.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: var(--primary-light);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .difficulty-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .difficulty-desc {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .hidden {
            display: none;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .hold-indicator {
            margin-top: 15px;
            font-size: 1.1rem;
            color: var(--warning);
            font-weight: 600;
        }
        
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.7;
        }
        
        @keyframes particle-float {
            0% { transform: translateY(0) scale(1); opacity: 0.7; }
            100% { transform: translateY(-20px) scale(0.5); opacity: 0; }
        }
        
        .warning {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            text-align: left;
        }
        
        .warning strong {
            color: var(--warning);
        }
        
        .records-section {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
        }
        
        .records-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .records-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .records-container {
                grid-template-columns: 1fr;
            }
        }
        
        .record-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
        }
        
        .record-card h3 {
            margin-bottom: 10px;
            color: var(--primary-light);
        }
        
        .record-list {
            list-style-type: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .record-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .best-record {
            color: var(--secondary);
            font-weight: bold;
        }

        .db-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
        }
        
        .db-online {
            background: var(--secondary);
            color: white;
        }
        
        .db-offline {
            background: var(--danger);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="logo-icon">ğŸŒ¬ï¸</span>
                <h1>å±æ¯æŒ‘æˆ°</h1>
            </div>
            <p class="tagline">æŒæ¡å‘¼å¸ç¯€å¥ï¼Œæå‡å°ˆæ³¨åŠ›èˆ‡æ”¾é¬†æ•ˆæœ</p>
            <div id="db-status" class="db-status db-offline">æ•¸æ“šåº«: é›¢ç·šæ¨¡å¼</div>
        </header>
        
        <div class="game-container">
            <div class="animation-section">
                <div class="breathing-animation">
                    <div class="lung-container">
                        <div class="lung" id="lung"></div>
                        <div class="breath-path"></div>
                        <div class="breath-dot" id="breath-dot" style="bottom: 10%;"></div>
                    </div>
                </div>
                
                <div class="instructions" id="instructions">
                    è«‹é¸æ“‡é›£åº¦ç´šåˆ¥é–‹å§‹ç·´ç¿’
                </div>
                
                <div class="timer" id="timer">0</div>
                <div class="phase" id="phase">æº–å‚™é–‹å§‹</div>
                
                <div class="hold-indicator hidden" id="hold-indicator">
                    å±æ¯ä¸­... ä¿æŒä½ï¼
                </div>
            </div>
            
            <div class="controls-section">
                <h2 style="margin-bottom: 20px;">å‘¼å¸æ¨¡å¼</h2>
                
                <div class="difficulty-selector" id="difficulty-selector">
                    <div class="difficulty-card" data-level="beginner">
                        <h3 class="difficulty-title">åˆç´š</h3>
                        <p class="difficulty-desc">å¸4ç§’ â†’ å±4ç§’ â†’ å‘¼7ç§’</p>
                    </div>
                    <div class="difficulty-card" data-level="intermediate">
                        <h3 class="difficulty-title">é€²éš</h3>
                        <p class="difficulty-desc">å¸5ç§’ â†’ å±7ç§’ â†’ å‘¼8ç§’</p>
                    </div>
                    <div class="difficulty-card" data-level="advanced">
                        <h3 class="difficulty-title">é«˜ç´š</h3>
                        <p class="difficulty-desc">å¸6ç§’ â†’ å±12ç§’ â†’ å‘¼10ç§’</p>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="inhale-time">0</div>
                        <div class="stat-label">å¸æ°£(ç§’)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="hold-time">0</div>
                        <div class="stat-label">å±æ¯(ç§’)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="exhale-time">0</div>
                        <div class="stat-label">å‘¼æ°£(ç§’)</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" id="start-btn">é–‹å§‹ç·´ç¿’</button>
                    <button class="btn btn-secondary hidden" id="pause-btn">æš«åœ</button>
                    <button class="btn btn-warning hidden" id="reset-btn">é‡æ–°é–‹å§‹</button>
                </div>
                
                <div class="warning">
                    <strong>å®‰å…¨æç¤ºï¼š</strong> å¦‚æœæ‚¨æ„Ÿåˆ°é ­æšˆæˆ–ä¸é©ï¼Œè«‹ç«‹å³åœæ­¢ç·´ç¿’ä¸¦æ¢å¾©æ­£å¸¸å‘¼å¸ã€‚åˆå­¸è€…è«‹å¾åˆç´šæ¨¡å¼é–‹å§‹ã€‚
                </div>
            </div>
        </div>
        
        <div class="records-section">
            <h2 class="records-title">å‘¼å¸è¨˜éŒ„</h2>
            <div class="records-container">
                <div class="record-card">
                    <h3>æœ€ä½³æˆç¸¾</h3>
                    <ul class="record-list" id="best-records">
                        <li class="record-item">è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
                <div class="record-card">
                    <h3>æœ€è¿‘ç·´ç¿’</h3>
                    <ul class="record-list" id="recent-records">
                        <li class="record-item">è¼‰å…¥ä¸­...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é›£åº¦è¨­å®š - å·²æ›´æ–°ç‚ºæ–°è¦æ±‚
        const difficultySettings = {
            beginner: {
                inhale: 4,
                hold: 4,
                exhale: 7,
                color: '#2ecc71'
            },
            intermediate: {
                inhale: 5,
                hold: 7,
                exhale: 8,
                color: '#3498db'
            },
            advanced: {
                inhale: 6,
                hold: 12,
                exhale: 10,
                color: '#9b59b6'
            }
        };
        
        // ==================== Supabase é…ç½® ====================
        // è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› Supabase é…ç½®
        const SUPABASE_URL = 'https://fayorxvfxtrycjiiiyfu.supabase.co';  // â† æ›¿æ›é€™è£¡
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZheW9yeHZmeHRyeWNqaWlpeWZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzY1MTAsImV4cCI6MjA3OTg1MjUxMH0.7znE_AaNg6zESUO-RoSsyFqxCgcxjPT_pQiN557e6Nw';  // â† æ›¿æ›é€™è£¡
        
        // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
        let supabase;
        let useLocalStorage = true;
        
        try {
            if (SUPABASE_URL && SUPABASE_ANON_KEY && 
                SUPABASE_URL !== 'https://your-project.supabase.co' && 
                SUPABASE_ANON_KEY !== 'your-anon-key') {
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                useLocalStorage = false;
                document.getElementById('db-status').textContent = 'æ•¸æ“šåº«: åœ¨ç·šæ¨¡å¼';
                document.getElementById('db-status').className = 'db-status db-online';
            }
        } catch (error) {
            console.error('Supabase åˆå§‹åŒ–å¤±æ•—:', error);
            useLocalStorage = true;
        }
        // ==================== Supabase é…ç½®çµæŸ ====================
        
        // DOM å…ƒç´ 
        const difficultySelector = document.getElementById('difficulty-selector');
        const instructions = document.getElementById('instructions');
        const timer = document.getElementById('timer');
        const phase = document.getElementById('phase');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const breathDot = document.getElementById('breath-dot');
        const lung = document.getElementById('lung');
        const holdIndicator = document.getElementById('hold-indicator');
        const inhaleTimeEl = document.getElementById('inhale-time');
        const holdTimeEl = document.getElementById('hold-time');
        const exhaleTimeEl = document.getElementById('exhale-time');
        const bestRecordsList = document.getElementById('best-records');
        const recentRecordsList = document.getElementById('recent-records');
        
        // ç‹€æ…‹è®Šæ•¸
        let currentDifficulty = null;
        let isPlaying = false;
        let currentPhase = 'inhale'; // inhale, hold, exhale
        let currentTime = 0;
        let cycleCount = 0;
        let totalSessionTime = 0;
        let animationInterval = null;
        let sessionStartTime = null;
        
        // åˆå§‹åŒ–
        function init() {
            // æ·»åŠ é›£åº¦é¸æ“‡äº‹ä»¶ç›£è½
            document.querySelectorAll('.difficulty-card').forEach(card => {
                card.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„activeé¡
                    document.querySelectorAll('.difficulty-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    // æ·»åŠ ç•¶å‰å¡ç‰‡çš„activeé¡
                    this.classList.add('active');
                    
                    // è¨­ç½®ç•¶å‰é›£åº¦
                    currentDifficulty = this.getAttribute('data-level');
                    
                    // æ›´æ–°çµ±è¨ˆä¿¡æ¯
                    inhaleTimeEl.textContent = difficultySettings[currentDifficulty].inhale;
                    holdTimeEl.textContent = difficultySettings[currentDifficulty].hold;
                    exhaleTimeEl.textContent = difficultySettings[currentDifficulty].exhale;
                    
                    // æ›´æ–°èªªæ˜
                    instructions.textContent = `æº–å‚™ç·´ç¿’ ${getDifficultyName(currentDifficulty)} æ¨¡å¼`;
                });
            });
            
            // é–‹å§‹æŒ‰éˆ•äº‹ä»¶
            startBtn.addEventListener('click', startBreathing);
            
            // æš«åœæŒ‰éˆ•äº‹ä»¶
            pauseBtn.addEventListener('click', pauseBreathing);
            
            // é‡ç½®æŒ‰éˆ•äº‹ä»¶
            resetBtn.addEventListener('click', resetBreathing);
            
            // è¼‰å…¥è¨˜éŒ„
            loadRecords();
        }
        
        // é–‹å§‹å‘¼å¸ç·´ç¿’
        function startBreathing() {
            if (!currentDifficulty) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é›£åº¦ç´šåˆ¥');
                return;
            }
            
            isPlaying = true;
            currentPhase = 'inhale';
            currentTime = 0;
            cycleCount = 0;
            totalSessionTime = 0;
            sessionStartTime = new Date();
            
            // æ›´æ–°UI
            startBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            
            // é–‹å§‹å‘¼å¸å¾ªç’°
            startBreathingCycle();
        }
        
        // é–‹å§‹å‘¼å¸å¾ªç’°
        function startBreathingCycle() {
            clearInterval(animationInterval);
            
            animationInterval = setInterval(() => {
                if (!isPlaying) return;
                
                const settings = difficultySettings[currentDifficulty];
                
                // æ›´æ–°ç•¶å‰éšæ®µæ™‚é–“
                currentTime++;
                totalSessionTime++;
                timer.textContent = currentTime;
                
                // æ ¹æ“šéšæ®µæ›´æ–°å‹•ç•«å’ŒæŒ‡ç¤º
                switch(currentPhase) {
                    case 'inhale':
                        // å¸æ°£éšæ®µ - åœ“é»ä¸‹é™
                        let inhaleProgress = (currentTime / settings.inhale) * 90;
                        breathDot.style.bottom = `${10 + inhaleProgress}%`;
                        phase.textContent = "å¸æ°£...";
                        phase.style.color = '#2ecc71';
                        instructions.textContent = "ç·©æ…¢å¸æ°£ï¼Œå¡«å……è‚ºéƒ¨";
                        lung.style.transform = `scale(${1 + (currentTime / settings.inhale) * 0.3})`;
                        
                        // å‰µå»ºå¸å…¥ç²’å­
                        if (currentTime % 2 === 0) {
                            createParticle('inhale');
                        }
                        
                        if (currentTime >= settings.inhale) {
                            currentPhase = 'hold';
                            currentTime = 0;
                            holdIndicator.classList.remove('hidden');
                        }
                        break;
                        
                    case 'hold':
                        // å±æ¯éšæ®µ - åœ“é»ä¿æŒä½ç½®
                        phase.textContent = "å±æ¯...";
                        phase.style.color = '#f39c12';
                        instructions.textContent = "ä¿æŒå‘¼å¸ï¼Œæ”¾é¬†èº«é«”";
                        holdIndicator.textContent = `å±æ¯ä¸­... ${currentTime}ç§’`;
                        
                        // å‰µå»ºå±æ¯ç²’å­
                        if (currentTime % 3 === 0) {
                            createParticle('hold');
                        }
                        
                        if (currentTime >= settings.hold) {
                            currentPhase = 'exhale';
                            currentTime = 0;
                            holdIndicator.classList.add('hidden');
                        }
                        break;
                        
                    case 'exhale':
                        // å‘¼æ°£éšæ®µ - åœ“é»ä¸Šå‡
                        let exhaleProgress = (currentTime / settings.exhale) * 90;
                        breathDot.style.bottom = `${100 - exhaleProgress}%`;
                        phase.textContent = "å‘¼æ°£...";
                        phase.style.color = '#e74c3c';
                        instructions.textContent = "ç·©æ…¢å‘¼æ°£ï¼Œé‡‹æ”¾å£“åŠ›";
                        lung.style.transform = `scale(${1.3 - (currentTime / settings.exhale) * 0.3})`;
                        
                        // å‰µå»ºå‘¼å‡ºç²’å­
                        if (currentTime % 2 === 0) {
                            createParticle('exhale');
                        }
                        
                        if (currentTime >= settings.exhale) {
                            // å®Œæˆä¸€å€‹å¾ªç’°
                            cycleCount++;
                            currentPhase = 'inhale';
                            currentTime = 0;
                            
                            // æ›´æ–°æŒ‡ç¤º
                            instructions.textContent = `å®Œæˆ ${cycleCount} å€‹å‘¼å¸å¾ªç’°ï¼ç¹¼çºŒä¸‹ä¸€å€‹...`;
                            
                            // æ¯å®Œæˆ3å€‹å¾ªç’°è‡ªå‹•ä¿å­˜ä¸€æ¬¡
                            if (cycleCount % 3 === 0) {
                                saveSessionRecord();
                            }
                        }
                        break;
                }
                
            }, 1000);
        }
        
        // å‰µå»ºç²’å­æ•ˆæœ
        function createParticle(type) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // è¨­ç½®ç²’å­ä½ç½®åœ¨åœ“é»é™„è¿‘
            const dotRect = breathDot.getBoundingClientRect();
            const containerRect = document.querySelector('.lung-container').getBoundingClientRect();
            
            const left = dotRect.left - containerRect.left + dotRect.width / 2;
            const bottom = dotRect.bottom - containerRect.top;
            
            particle.style.left = `${left}px`;
            particle.style.bottom = `${bottom}px`;
            
            // æ ¹æ“šéšæ®µè¨­ç½®ç²’å­é¡è‰²å’Œå‹•ç•«
            switch(type) {
                case 'inhale':
                    particle.style.background = '#2ecc71';
                    particle.style.animation = 'particle-float 1.5s forwards';
                    break;
                case 'hold':
                    particle.style.background = '#f39c12';
                    particle.style.animation = 'particle-float 2s forwards';
                    break;
                case 'exhale':
                    particle.style.background = '#e74c3c';
                    particle.style.animation = 'particle-float 1s forwards';
                    break;
            }
            
            document.querySelector('.lung-container').appendChild(particle);
            
            // ç²’å­å‹•ç•«çµæŸå¾Œç§»é™¤
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 2000);
        }
        
        // æš«åœå‘¼å¸ç·´ç¿’
        function pauseBreathing() {
            isPlaying = !isPlaying;
            pauseBtn.textContent = isPlaying ? 'æš«åœ' : 'ç¹¼çºŒ';
            
            if (isPlaying) {
                switch(currentPhase) {
                    case 'inhale':
                        instructions.textContent = "ç·©æ…¢å¸æ°£ï¼Œå¡«å……è‚ºéƒ¨";
                        break;
                    case 'hold':
                        instructions.textContent = "ä¿æŒå‘¼å¸ï¼Œæ”¾é¬†èº«é«”";
                        break;
                    case 'exhale':
                        instructions.textContent = "ç·©æ…¢å‘¼æ°£ï¼Œé‡‹æ”¾å£“åŠ›";
                        break;
                }
            } else {
                instructions.textContent = "å·²æš«åœ";
                phase.textContent = "æš«åœä¸­";
                phase.style.color = '#95a5a6';
            }
        }
        
        // é‡ç½®å‘¼å¸ç·´ç¿’
        function resetBreathing() {
            clearInterval(animationInterval);
            isPlaying = false;
            currentTime = 0;
            
            // ä¿å­˜æœ€å¾Œçš„è¨˜éŒ„
            if (cycleCount > 0) {
                saveSessionRecord();
            }
            
            cycleCount = 0;
            totalSessionTime = 0;
            
            // é‡ç½®UI
            timer.textContent = "0";
            phase.textContent = "æº–å‚™é–‹å§‹";
            phase.style.color = 'white';
            instructions.textContent = "è«‹é¸æ“‡é›£åº¦ç´šåˆ¥é–‹å§‹ç·´ç¿’";
            breathDot.style.bottom = "10%";
            lung.style.transform = "scale(1)";
            holdIndicator.classList.add('hidden');
            
            // é¡¯ç¤ºé–‹å§‹æŒ‰éˆ•
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
            resetBtn.classList.add('hidden');
        }
        
        // ä¿å­˜ç·´ç¿’è¨˜éŒ„
        async function saveSessionRecord() {
            if (cycleCount === 0) return;
            
            const recordData = {
                difficulty: currentDifficulty,
                cycles: cycleCount,
                total_time: totalSessionTime,
                created_at: new Date().toISOString(),
                inhale_duration: difficultySettings[currentDifficulty].inhale,
                hold_duration: difficultySettings[currentDifficulty].hold,
                exhale_duration: difficultySettings[currentDifficulty].exhale
            };
            
            if (!useLocalStorage && supabase) {
                // ä½¿ç”¨ Supabase ä¿å­˜
                try {
                    const { data, error } = await supabase
                        .from('breathing_records')
                        .insert([recordData])
                        .select();
                    
                    if (error) {
                        console.error('Supabase ä¿å­˜å¤±æ•—:', error);
                        saveToLocalStorage(recordData);
                    } else {
                        console.log('è¨˜éŒ„å·²ä¿å­˜åˆ° Supabase:', data);
                        loadRecords();
                    }
                } catch (err) {
                    console.error('Supabase ä¿å­˜ç•°å¸¸:', err);
                    saveToLocalStorage(recordData);
                }
            } else {
                // ä½¿ç”¨æœ¬åœ°å­˜å„²
                saveToLocalStorage(recordData);
            }
        }
        
        // ä½¿ç”¨æœ¬åœ°å­˜å„²ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
        function saveToLocalStorage(recordData) {
            try {
                const records = JSON.parse(localStorage.getItem('breathing_records') || '[]');
                records.push({
                    id: Date.now(),
                    ...recordData
                });
                localStorage.setItem('breathing_records', JSON.stringify(records));
                loadRecords();
            } catch (err) {
                console.error('æœ¬åœ°å­˜å„²å¤±æ•—:', err);
            }
        }
        
        // è¼‰å…¥è¨˜éŒ„
        async function loadRecords() {
            if (!useLocalStorage && supabase) {
                // å¾ Supabase è¼‰å…¥
                try {
                    const { data, error } = await supabase
                        .from('breathing_records')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('Supabase è¼‰å…¥å¤±æ•—:', error);
                        loadFromLocalStorage();
                    } else {
                        console.log('å¾ Supabase è¼‰å…¥è¨˜éŒ„:', data);
                        displayRecords(data);
                    }
                } catch (err) {
                    console.error('Supabase è¼‰å…¥ç•°å¸¸:', err);
                    loadFromLocalStorage();
                }
            } else {
                // å¾æœ¬åœ°å­˜å„²è¼‰å…¥
                loadFromLocalStorage();
            }
        }
        
        // å¾æœ¬åœ°å­˜å„²è¼‰å…¥è¨˜éŒ„
        function loadFromLocalStorage() {
            try {
                const records = JSON.parse(localStorage.getItem('breathing_records') || '[]');
                displayRecords(records);
            } catch (err) {
                console.error('å¾æœ¬åœ°å­˜å„²è¼‰å…¥è¨˜éŒ„å¤±æ•—:', err);
            }
        }
        
        // é¡¯ç¤ºè¨˜éŒ„
        function displayRecords(records) {
            // æ¸…ç©ºåˆ—è¡¨
            bestRecordsList.innerHTML = '';
            recentRecordsList.innerHTML = '';
            
            if (records.length === 0) {
                bestRecordsList.innerHTML = '<li class="record-item">å°šç„¡è¨˜éŒ„</li>';
                recentRecordsList.innerHTML = '<li class="record-item">å°šç„¡è¨˜éŒ„</li>';
                return;
            }
            
            // æ‰¾å‡ºæœ€ä½³æˆç¸¾ï¼ˆæŒ‰å¾ªç’°æ¬¡æ•¸ï¼‰
            const bestByDifficulty = {};
            records.forEach(record => {
                const difficulty = record.difficulty;
                if (!bestByDifficulty[difficulty] || record.cycles > bestByDifficulty[difficulty].cycles) {
                    bestByDifficulty[difficulty] = record;
                }
            });
            
            // é¡¯ç¤ºæœ€ä½³æˆç¸¾
            Object.keys(bestByDifficulty).forEach(difficulty => {
                const record = bestByDifficulty[difficulty];
                const listItem = document.createElement('li');
                listItem.className = 'record-item best-record';
                listItem.innerHTML = `
                    <span>${getDifficultyName(difficulty)}</span>
                    <span>${record.cycles} å¾ªç’°</span>
                `;
                bestRecordsList.appendChild(listItem);
            });
            
            // é¡¯ç¤ºæœ€è¿‘5æ¢è¨˜éŒ„
            const recentRecords = records.slice(0, 5);
            recentRecords.forEach(record => {
                const listItem = document.createElement('li');
                listItem.className = 'record-item';
                const date = new Date(record.created_at).toLocaleDateString();
                listItem.innerHTML = `
                    <span>${getDifficultyName(record.difficulty)} - ${date}</span>
                    <span>${record.cycles} å¾ªç’°</span>
                `;
                recentRecordsList.appendChild(listItem);
            });
        }
        
        // ç²å–é›£åº¦åç¨±
        function getDifficultyName(level) {
            const names = {
                beginner: 'åˆç´š',
                intermediate: 'é€²éš',
                advanced: 'é«˜ç´š'
            };
            return names[level];
        }
        
        // åˆå§‹åŒ–æ‡‰ç”¨
        init();
    </script>
</body>
</html>
